<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Fichaje Puertas Lloris</title>
<style>
  body{margin:0;font-family:system-ui,Arial;background:#edf1f5;color:#0f172a}
  .bar{position:fixed;top:6px;left:50%;transform:translateX(-50%);
       background:#fff;padding:6px 12px;border-radius:8px;
       box-shadow:0 4px 12px rgba(0,0,0,.15);font-weight:600;z-index:20}
  .msg-ok{color:#0f6b35}.msg-err{color:#a21919}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:70px auto;max-width:600px}
  .row{background:#fff;padding:8px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1);text-align:center}
  .btn{padding:10px;border-radius:6px;color:#fff;font-weight:700;cursor:pointer;margin:4px}
  .in{background:linear-gradient(180deg,#168a40,#0f6b35)}
  .out{background:linear-gradient(180deg,#c43535,#a12626)}
  .btn[aria-busy="true"]{opacity:0.6;pointer-events:none}
  video{width:100%;border-radius:8px;background:#000}
  canvas{display:none}
</style>
</head>
<body>
<div id="bar" class="bar" hidden><span id="barMsg"></span></div>

<div style="max-width:360px;margin:0 auto">
  <h3 style="text-align:center">Cámara</h3>
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas"></canvas>
  <div id="camStatus" style="font-size:12px;text-align:center;color:#555">Inicializando cámara…</div>
</div>

<div class="grid" id="grid"></div>

<audio id="beepAudio" preload="auto">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<script>
/*** CONFIG ***/
const ENDPOINT="https://script.google.com/macros/s/AKfycbzQgMYWw08WXbJr5_SOhGKiHyqlU_Sh0ZU67dg2yS9DjDBMRMUbLemPBU9apPdKQa-c/exec"; 
const WORKERS=["Luis Bou Garcia","Emilio Muñoz Usero","Emilio Fernandez Muñoz","Fernando Lloris Sanchez"];
const TARGET_WIDTH=360, JPEG_QUALITY=0.5;

/*** DOM ***/
const grid=document.getElementById('grid');
const bar=document.getElementById('bar'), barMsg=document.getElementById('barMsg');
const video=document.getElementById('video'), canvas=document.getElementById('canvas'), camStatus=document.getElementById('camStatus');
const beepTag=document.getElementById('beepAudio');

/*** Cámara ***/
let camReady=false;
(async()=>{
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false});
    video.srcObject=stream;
    video.addEventListener('loadeddata',()=>{camReady=true;camStatus.textContent='Cámara lista';},{once:true});
  }catch{ camStatus.textContent='Sin acceso a cámara'; }
})();
function captureDataURL(){
  if(!camReady||!video.videoWidth) return '';
  const vw=video.videoWidth,vh=video.videoHeight,scale=TARGET_WIDTH/vw;
  const tw=Math.round(vw*scale),th=Math.round(vh*scale);
  canvas.width=tw;canvas.height=th;
  canvas.getContext('2d').drawImage(video,0,0,tw,th);
  return canvas.toDataURL('image/jpeg',JPEG_QUALITY);
}

/*** Utils ***/
function setBar(msg,ok=true){barMsg.textContent=msg;barMsg.className=ok?'msg-ok':'msg-err';bar.hidden=false;}
function beepOk(){try{beepTag.currentTime=0;beepTag.play();}catch{}}

/*** Fichaje ***/
async function ficha(nombre,tipo,btn){
  btn.setAttribute('aria-busy','true');
  setBar(`Enviando — ${nombre} · ${tipo.toUpperCase()}`,true);

  const durl=captureDataURL();
  try{
    const res=await fetch(ENDPOINT,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({nombre,tipo,photo:durl})
    });
    const data=await res.json();
    if(data.ok){
      setTimeout(()=>{
        const hora=new Date().toLocaleTimeString('es-ES',{hour12:false});
        beepOk();
        setBar(`OK ${nombre} — ${tipo.toUpperCase()} ${hora}`,true);
        btn.removeAttribute('aria-busy');
      },2000);
    }else{
      setBar(`Error foto — ${nombre}`,false);
      btn.removeAttribute('aria-busy');
    }
  }catch(err){
    setBar(`Error conexión — ${nombre}`,false);
    btn.removeAttribute('aria-busy');
  }
}

/*** Render grid ***/
WORKERS.forEach(n=>{
  const row=document.createElement('div'); row.className='row';
  const name=document.createElement('div'); name.textContent=n;
  const bIn=document.createElement('div'); bIn.className='btn in'; bIn.textContent='Entrada';
  const bOut=document.createElement('div'); bOut.className='btn out'; bOut.textContent='Salida';
  bIn.onclick=()=>ficha(n,'entrada',bIn);
  bOut.onclick=()=>ficha(n,'salida',bOut);
  row.appendChild(name); row.appendChild(bIn); row.appendChild(bOut);
  grid.appendChild(row);
});
</script>
</body>
</html>
