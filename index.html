<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fichaje Puertas Lloris</title>
  <style>
    body{margin:0;font-family:system-ui,Arial,sans-serif;background:#f4f6f8;color:#111;text-align:center}
    h1{margin:14px 0;font-size:22px;font-weight:800}

    .camWrap{display:flex;justify-content:center;margin:10px auto}
    .card{width:280px;background:#fff;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.1);padding:8px}
    .card h3{margin:0 0 6px;font-size:14px;font-weight:700}
    .cam{width:100%;aspect-ratio:4/3;background:#000;border-radius:10px;overflow:hidden}
    video,canvas{width:100%;height:100%;display:block;transform:scaleX(-1)}
    #camStatus{margin-top:4px;font-size:12px;color:#666}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;max-width:950px;margin:20px auto}
    .cardW{background:#fff;border-radius:12px;padding:10px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
    .name{font-weight:700;margin-bottom:6px;font-size:15px}

    .btn{display:inline-flex;align-items:center;justify-content:center;width:90px;height:42px;
         border-radius:10px;color:#fff;font-weight:700;font-size:15px;cursor:pointer;
         box-shadow:0 3px 8px rgba(0,0,0,.12);margin:0 4px;position:relative;user-select:none}
    .btn:active{transform:scale(.97)}
    .in{background:#16a34a}.out{background:#dc2626}

    .btn[aria-busy="true"]::after{
      content:"Enviando…";
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      background:rgba(0,0,0,.25);border-radius:inherit;color:#fff;font-weight:800;font-size:13px
    }

    .status{margin:16px auto;padding:10px 14px;background:#fff;border:1px solid #ddd;border-radius:12px;
            width:min(600px,90%);font-size:15px;font-weight:600}
  </style>
</head>
<body>
  <h1>Fichaje Puertas Lloris</h1>

  <div class="camWrap">
    <section class="card">
      <h3>Cámara</h3>
      <div class="cam">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="canvas" hidden></canvas>
      </div>
      <div id="camStatus">Cargando cámara…</div>
    </section>
  </div>

  <div class="grid" id="grid"></div>
  <div id="status" class="status">Listo</div>

  <!-- Fallback audio -->
  <audio id="beepAudio" preload="auto">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
  </audio>

<script>
/*** CONFIG ***/
const ENDPOINT="https://script.google.com/macros/s/AKfycbzQgMYWw08WXbJr5_SOhGKiHyqlU_Sh0ZU67dg2yS9DjDBMRMUbLemPBU9apPdKQa-c/exec";
const WORKERS=["Luis Bou Garcia","Emilio Muñoz Usero","Emilio Fernandez Muñoz","Fernando Lloris Sanchez"];
const TARGET_WIDTH=480, JPEG_QUALITY=0.6;

/*** Cámara ***/
let camReady=false;
const video=document.getElementById('video'),canvas=document.getElementById('canvas'),camStatus=document.getElementById('camStatus');
(async()=>{
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:false});
    video.srcObject=stream;await video.play().catch(()=>{});
    camReady=true;camStatus.textContent="Cámara lista";
  }catch{camStatus.textContent="Sin acceso a cámara"; }
})();
function captureDataURL(){
  if(!camReady||!video.videoWidth)return"";
  const vw=video.videoWidth,vh=video.videoHeight,scale=TARGET_WIDTH/vw;
  const tw=Math.round(vw*scale),th=Math.round(vh*scale);
  canvas.width=tw;canvas.height=th;
  canvas.getContext("2d").drawImage(video,0,0,tw,th);
  return canvas.toDataURL("image/jpeg",JPEG_QUALITY);
}

/*** Audio ***/
let AC=null;
function unlockAudioOnce(){
  if(AC) return;
  try{
    const Ctx=window.AudioContext||window.webkitAudioContext;
    AC=new Ctx();AC.resume&&AC.resume();
    const o=AC.createOscillator(),g=AC.createGain();g.gain.value=0;o.connect(g);g.connect(AC.destination);
    o.start();o.stop(AC.currentTime+0.01);
  }catch{}
}
function beepOk(){
  try{
    if(!AC){const Ctx=window.AudioContext||window.webkitAudioContext;AC=new Ctx();}
    AC.resume&&AC.resume();
    const o=AC.createOscillator(),g=AC.createGain();o.type="sine";o.frequency.value=880;
    g.gain.setValueAtTime(0.06,AC.currentTime);o.connect(g);g.connect(AC.destination);
    o.start();o.stop(AC.currentTime+0.12);
  }catch{try{const a=document.getElementById("beepAudio");a.currentTime=0;a.play().catch(()=>{});}catch{}}
}

/*** Utilidades ***/
const statusBox=document.getElementById("status");
function setStatus(msg,ok=true){statusBox.textContent=msg;statusBox.style.color=ok?"#0a0":"#b11";}

/*** Lógica de fichaje ***/
function fichar(nombre,tipo,btn){
  unlockAudioOnce();
  btn.setAttribute("aria-busy","true");

  const url=`${ENDPOINT}?nombre=${encodeURIComponent(nombre)}&tipo=${encodeURIComponent(tipo)}&t=${Date.now()}`;
  fetch(url).then(r=>r.text()).then(()=>{
    btn.removeAttribute("aria-busy");
    beepOk();
    const stamp=new Date().toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
    setStatus(`OK ${nombre} — ${tipo} (${stamp})`,true);

    const durl=captureDataURL();
    if(durl){
      navigator.sendBeacon(ENDPOINT,JSON.stringify({nombre,tipo,photo:durl}));
    }
  }).catch(()=>{
    btn.removeAttribute("aria-busy");
    setStatus(`${nombre} — error`,false);
  });
}

/*** Render ***/
const grid=document.getElementById("grid");
WORKERS.forEach(n=>{
  const card=document.createElement("div");card.className="cardW";
  const name=document.createElement("div");name.className="name";name.textContent=n;
  const bIn=document.createElement("div");bIn.className="btn in";bIn.textContent="Entrada";
  const bOut=document.createElement("div");bOut.className="btn out";bOut.textContent="Salida";
  bIn.onclick=()=>fichar(n,"entrada",bIn);
  bOut.onclick=()=>fichar(n,"salida",bOut);
  card.appendChild(name);card.appendChild(bIn);card.appendChild(bOut);
  grid.appendChild(card);
});
</script>
</body>
</html>
