<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Fichaje Puertas Lloris</title>
<style>
  :root{--gap:10px;--btnH:40px;--btnFS:14px;--nameFS:14px}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,Arial,sans-serif;background:#edf1f5;color:#0f172a}

  /* Contenedor compacto */
  .wrap{max-width:880px;margin:4px auto 4px;padding:0 8px}
  h1{margin:4px 0 6px;text-align:center;font-size:18px;font-weight:800}

  /* Barra de estado ARRIBA */
  .bar{position:fixed;left:50%;top:6px;transform:translateX(-50%);
       width:min(860px,94vw);background:#fff;border-radius:10px;
       box-shadow:0 8px 20px rgba(0,0,0,.15);
       padding:6px 10px;display:flex;align-items:center;justify-content:center;
       font-weight:700;font-size:14px;z-index:20}
  .msg-ok{color:#0f6b35}.msg-err{color:#a21919}.bar[hidden]{display:none}
  .spacer{height:38px}

  /* Cámara compacta */
  .camWrap{display:flex;justify-content:center;margin:2px 0 8px}
  .card{width:min(300px,90vw);background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,.08);padding:8px}
  .card h3{margin:0 0 4px;font-size:12px;font-weight:700;text-align:center}
  .cam{width:100%;aspect-ratio:4/3;background:#000;border-radius:8px;overflow:hidden}
  video{width:100%;height:100%;display:block;transform:scaleX(-1)}
  canvas{display:none}
  .hint{text-align:center;font-size:11px;color:#666;margin-top:4px}

  /* Grid compacto 2×2 */
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .row{background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.06);
       padding:8px;display:flex;flex-direction:column;align-items:center}
  .name{font-weight:700;font-size:var(--nameFS);margin-bottom:6px;text-align:center}
  .btns{display:flex;gap:8px;width:100%;justify-content:center}
  .btn{position:relative;flex:1;min-width:90px;height:var(--btnH);border-radius:10px;color:#fff;font-weight:700;
       font-size:var(--btnFS);display:flex;align-items:center;justify-content:center;user-select:none;cursor:pointer;
       box-shadow:0 3px 8px rgba(0,0,0,.08)}
  .btn:active{transform:translateY(1px)}
  .in{background:linear-gradient(180deg,#168a40,#0f6b35)}
  .out{background:linear-gradient(180deg,#c43535,#a12626)}
  .btn[aria-busy="true"]::after{
    content:"Enviando…";position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    border-radius:inherit;background:rgba(0,0,0,.22);color:#fff;font-weight:700;font-size:12px
  }
</style>
</head>
<body>
<div id="bar" class="bar" hidden><span id="barMsg" class="msg-ok">Listo</span></div>
<div class="spacer" aria-hidden="true"></div>

<div class="wrap">
  <h1>Fichaje Puertas Lloris</h1>

  <div class="camWrap">
    <section class="card">
      <h3>Cámara</h3>
      <div class="cam"><video id="video" playsinline autoplay muted></video><canvas id="canvas"></canvas></div>
      <div id="camStatus" class="hint">Inicializando cámara…</div>
    </section>
  </div>

  <div id="grid" class="grid"></div>
</div>

<!-- GET por iframe para el fichaje (sin CORS/JSONP) -->
<iframe id="hiddenFrame" name="hiddenFrame" style="display:none"></iframe>

<!-- Beep fallback -->
<audio id="beepAudio" preload="auto">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<script>
/*** CONFIG ***/
const ENDPOINT="https://script.google.com/macros/s/AKfycbzQgMYWw08WXbJr5_SOhGKiHyqlU_Sh0ZU67dg2yS9DjDBMRMUbLemPBU9apPdKQa-c/exec";
const WORKERS=["Luis Bou Garcia","Emilio Muñoz Usero","Emilio Fernandez Muñoz","Fernando Lloris Sanchez"];

/* Cámara más pequeña => menos alto en pantalla y foto más ligera */
const TARGET_WIDTH=360, JPEG_QUALITY=0.5;

/*** DOM ***/
const grid=document.getElementById('grid');
const bar=document.getElementById('bar'), barMsg=document.getElementById('barMsg');
const video=document.getElementById('video'), canvas=document.getElementById('canvas'), camStatus=document.getElementById('camStatus');
const hiddenFrame=document.getElementById('hiddenFrame');
const beepTag=document.getElementById('beepAudio');

/*** Audio persistente ***/
let AC=null;
function unlockAudioOnce(){ if(AC) return; try{ const Ctx=window.AudioContext||window.webkitAudioContext; AC=new Ctx(); AC.resume&&AC.resume(); const o=AC.createOscillator(),g=AC.createGain(); g.gain.value=0;o.connect(g);g.connect(AC.destination);o.start();o.stop(AC.currentTime+0.01);}catch{} }
function beepOk(){ try{ if(!AC){const Ctx=window.AudioContext||window.webkitAudioContext;AC=new Ctx();} AC.resume&&AC.resume(); const o=AC.createOscillator(),g=AC.createGain(); o.type='sine';o.frequency.value=880; g.gain.setValueAtTime(0.06,AC.currentTime); o.connect(g); g.connect(AC.destination); o.start(); o.stop(AC.currentTime+0.12);}catch{ try{beepTag.currentTime=0;beepTag.play().catch(()=>{});}catch{} } }

/*** Cámara ***/
let camReady=false;
(async()=>{ try{
  const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false});
  video.srcObject=stream;
  video.addEventListener('loadeddata',()=>{camReady=true;camStatus.textContent='Cámara lista';},{once:true});
  await video.play().catch(()=>{});
}catch{ camStatus.textContent='Sin acceso a cámara'; }})();
function captureDataURL(){
  if(!camReady||!video.videoWidth) return '';
  const vw=video.videoWidth,vh=video.videoHeight,scale=TARGET_WIDTH/vw;
  const tw=Math.round(vw*scale),th=Math.round(vh*scale);
  canvas.width=tw;canvas.height=th;
  canvas.getContext('2d').drawImage(video,0,0,tw,th);
  return canvas.toDataURL('image/jpeg',JPEG_QUALITY);
}

/*** Utils ***/
function setBar(msg,ok=true){ barMsg.textContent=msg; barMsg.className=ok?'msg-ok':'msg-err'; bar.hidden=false; }

/*** POST foto con fetch(keepalive) ***/
async function postFoto(nombre, tipo, durl){
  if(!durl) return;
  try{
    await fetch(ENDPOINT, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      keepalive: true,
      body: JSON.stringify({ nombre, tipo, photo: durl })
    });
  }catch(_){}
}

/*** Fichaje ***/
function ficha(nombre,tipo,btn){
  unlockAudioOnce();
  btn.setAttribute('aria-busy','true');
  setBar(`Enviando — ${nombre} · ${tipo.toUpperCase()}`, true);

  // Foto inmediata por POST (sin sendBeacon)
  const durl=captureDataURL();
  postFoto(nombre, tipo, durl);

  // Alta de fichaje por GET (rápido, sin CORS/JSONP)
  hiddenFrame.src = `${ENDPOINT}?nombre=${encodeURIComponent(nombre)}&tipo=${encodeURIComponent(tipo)}&t=${Date.now()}`;

  // OK optimista
  beepOk();
  setBar(`OK ${nombre} — ${tipo.toUpperCase()} (enviado)`, true);
  btn.removeAttribute('aria-busy');
}

/*** Render 2×2 compacto ***/
WORKERS.forEach(nombre=>{
  const row=document.createElement('div'); row.className='row';
  const name=document.createElement('div'); name.className='name'; name.textContent=nombre;
  const btns=document.createElement('div'); btns.className='btns';
  const bIn=document.createElement('div'); bIn.className='btn in'; bIn.textContent='Entrada';
  const bOut=document.createElement('div'); bOut.className='btn out'; bOut.textContent='Salida';
  bIn.onclick=()=>ficha(nombre,'entrada',bIn);
  bOut.onclick=()=>ficha(nombre,'salida',bOut);
  btns.appendChild(bIn); btns.appendChild(bOut);
  row.appendChild(name); row.appendChild(btns);
  grid.appendChild(row);
});
</script>
</body>
</html>
