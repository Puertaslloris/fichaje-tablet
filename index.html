<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Fichaje Puertas Lloris</title>
<style>
  :root{ --gap:12px; --btnH:52px; --fz:16px; --green:#16a34a; --red:#dc2626; }
  *{ box-sizing:border-box }
  body{ margin:0; font-family:system-ui,Arial,sans-serif; background:#eef2f6; color:#111; }
  .wrap{ max-width:920px; margin:0 auto; padding:12px; }
  h1{ text-align:center; font-size:20px; margin:8px 0 12px; }

  /* Cámara */
  .camCard{ background:#fff; border-radius:12px; box-shadow:0 1px 10px rgba(0,0,0,.09); padding:8px; margin-bottom:12px;
            display:flex; justify-content:center; }
  .camCol{ display:flex; flex-direction:column; align-items:center; width:100%; }
  .camBox{ width:100%; max-width:560px; aspect-ratio:4/3; background:#000; border-radius:10px; overflow:hidden; }
  video{ width:100%; height:100%; display:block; transform:scaleX(-1); }
  canvas{ display:none; }
  #camStatus{ text-align:center; font-size:12px; color:#666; margin-top:6px; }

  /* Trabajadores */
  .grid{ display:grid; gap:12px; grid-template-columns:repeat(2,1fr); }
  @media (min-width:1020px){ .grid{ grid-template-columns:repeat(4,1fr);} }
  @media (max-width:540px){ .grid{ grid-template-columns:1fr;} }

  .worker{ background:#fff; border-radius:12px; box-shadow:0 1px 6px rgba(0,0,0,.08); padding:10px; }
  .name{ font-weight:800; text-align:center; font-size:15px; margin-bottom:8px; }
  .btns{ display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .btn{
    position:relative; height:var(--btnH); border:0; border-radius:10px;
    font-size:var(--fz); font-weight:800; color:#fff; cursor:pointer;
    box-shadow:0 3px 10px rgba(0,0,0,.12);
  }
  .btn:active{ transform:scale(.985); }
  .in{ background:var(--green); } .out{ background:var(--red); }
  .btn[aria-busy="true"]{ filter:contrast(.85) saturate(.9); }
  .btn[aria-busy="true"]::after{
    content:"Enviando…"; position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    background:rgba(0,0,0,.18); border-radius:inherit; color:#fff; font-weight:800;
  }

  /* Barra estado */
  .bar{ margin-top:12px; padding:10px; border-radius:10px; background:#fff; box-shadow:0 1px 10px rgba(0,0,0,.1);
        text-align:center; font-weight:800; font-size:14px; }
  .ok{ color:#0f6b35 } .err{ color:#b91c1c }
</style>
</head>
<body>
<div class="wrap">
  <h1>Fichaje Puertas Lloris</h1>

  <div class="camCard">
    <div class="camCol">
      <div class="camBox">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="canvas"></canvas>
      </div>
      <div id="camStatus">Cargando cámara…</div>
    </div>
  </div>

  <div id="workers" class="grid"></div>
  <div id="status" class="bar">Listo</div>
</div>

<script>
/* CONFIG */
const WEBAPP="https://script.google.com/macros/s/AKfycbzQgMYWw08WXbJr5_SOhGKiHyqlU_Sh0ZU67dg2yS9DjDBMRMUbLemPBU9apPdKQa-c/exec";
const PEOPLE=["Luis Bou Garcia","Emilio Muñoz Usero","Emilio Fernandez Muñoz","Fernando Lloris Sanchez"];

/* DOM */
const video=document.getElementById("video"), canvas=document.getElementById("canvas"), camStatus=document.getElementById("camStatus");
const statusBox=document.getElementById("status");

/* Audio: WebAudio con desbloqueo en primer toque */
let audioCtx=null;
function ensureAudio(){ if(!audioCtx){ const C=window.AudioContext||window.webkitAudioContext; audioCtx=new C(); } if(audioCtx.state==="suspended") audioCtx.resume(); }
function unlock(){ ensureAudio(); window.removeEventListener("pointerdown",unlock); window.removeEventListener("keydown",unlock); }
window.addEventListener("pointerdown",unlock,{once:true}); window.addEventListener("keydown",unlock,{once:true});
function beep(){
  try{
    ensureAudio();
    const t=audioCtx.currentTime, o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type="square"; o.frequency.value=1000; g.gain.setValueAtTime(0.22,t);
    g.gain.exponentialRampToValueAtTime(0.001,t+0.28);
    o.connect(g); g.connect(audioCtx.destination); o.start(t); o.stop(t+0.3);
  }catch(_){}
}

/* Cámara */
let camReady=false;
(async()=>{
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:false});
    video.srcObject=stream; await video.play().catch(()=>{});
    camReady=true; camStatus.textContent="Cámara lista";
  }catch(_){ camStatus.textContent="Sin acceso a cámara"; }
})();
function captureDataURL(){
  if(!camReady||!video.videoWidth) return "";
  canvas.width=video.videoWidth; canvas.height=video.videoHeight;
  const ctx=canvas.getContext("2d");
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  return canvas.toDataURL("image/jpeg",0.6);
}

/* Estado */
function setStatus(msg,ok=true){ statusBox.textContent=msg; statusBox.className="bar "+(ok?"ok":"err"); }

/* JSONP util */
function jsonp(url,cb){
  const id="cb_"+Math.random().toString(36).slice(2);
  window[id]=d=>{ try{cb(d);}finally{ delete window[id]; s.remove(); } };
  const s=document.createElement("script");
  s.src=url+(url.includes("?")?"&":"?")+"callback="+id;
  s.onerror=()=>{ try{cb({ok:false,error:"jsonp"});}finally{ delete window[id]; s.remove(); } };
  document.head.appendChild(s);
}

/* Fichaje */
function fichar(nombre,tipo,btn){
  btn.setAttribute("aria-busy","true");
  jsonp(`${WEBAPP}?nombre=${encodeURIComponent(nombre)}&tipo=${tipo}`, r=>{
    btn.removeAttribute("aria-busy");
    if(!r||!r.ok){ setStatus(`${nombre} — error`,false); return; }
    const t=new Date().toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
    setStatus(`OK ${nombre} — ${tipo} (${t})`,true);
    beep();
    const d=captureDataURL();
    if(d){ navigator.sendBeacon(WEBAPP, JSON.stringify({token:r.token||"", photo:d, nombre, tipo})); }
  });
}

/* Render */
const grid=document.getElementById("workers");
PEOPLE.forEach(n=>{
  const card=document.createElement("div"); card.className="worker";
  const name=document.createElement("div"); name.className="name"; name.textContent=n;
  const btns=document.createElement("div"); btns.className="btns";
  const bIn=document.createElement("button"); bIn.className="btn in";  bIn.textContent="Entrada";
  const bOut=document.createElement("button");bOut.className="btn out"; bOut.textContent="Salida";
  bIn.onclick=()=>fichar(n,"entrada",bIn); bOut.onclick=()=>fichar(n,"salida",bOut);
  btns.appendChild(bIn); btns.appendChild(bOut); card.appendChild(name); card.appendChild(btns); grid.appendChild(card);
});
</script>
</body>
</html>
