<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Fichaje Puertas Lloris</title>
<style>
  :root{
    --gap:14px; --maxw:900px;
    --btnH:48px; --btnFS:17px; --nameFS:16px;
    --green:#168a40; --green2:#0f6b35; --red:#c43535; --red2:#a12626;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Arial,sans-serif;background:#edf1f5;color:#0f172a}
  .wrap{max-width:var(--maxw);margin:10px auto 84px;padding:0 12px}
  h1{text-align:center;margin:0 0 10px;font-size:22px;font-weight:800}

  /* Cámara arriba, centrada */
  .camWrap{display:flex;justify-content:center;margin-bottom:16px}
  .card{width:min(360px,90vw);background:#fff;border-radius:14px;box-shadow:0 10px 28px rgba(15,23,42,.08);padding:10px}
  .card h3{margin:0 0 6px;font-size:13px;font-weight:800;text-align:center}
  .cam{width:100%;aspect-ratio:4/3;background:#000;border-radius:10px;overflow:hidden}
  video{width:100%;height:100%;display:block;transform:scaleX(-1)} /* espejo solo UI */
  canvas{display:none}
  .hint{text-align:center;font-size:12px;color:#666;margin-top:6px}

  /* Cuadrícula de trabajadores */
  .grid{display:grid;gap:var(--gap)}
  @media (min-width:600px){ .grid{grid-template-columns:1fr 1fr} }

  .row{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);
       padding:12px;display:flex;flex-direction:column;align-items:center}
  .name{font-weight:700;font-size:var(--nameFS);margin-bottom:8px;text-align:center}
  .btns{display:flex;gap:10px;width:100%;justify-content:center}
  .btn{flex:1;min-width:110px;height:var(--btnH);border-radius:10px;color:#fff;font-weight:800;font-size:var(--btnFS);
       display:flex;align-items:center;justify-content:center;cursor:pointer;user-select:none;box-shadow:0 4px 10px rgba(0,0,0,.08)}
  .btn.in{background:linear-gradient(180deg,var(--green),var(--green2))}
  .btn.out{background:linear-gradient(180deg,var(--red),var(--red2))}
  .btn:active{transform:translateY(1px)}
  .btn[aria-busy="true"]{filter:grayscale(.2) brightness(.95)}

  /* Barra inferior de estado */
  .bar{position:fixed;left:50%;bottom:12px;transform:translateX(-50%);width:min(860px,94vw);
       background:#fff;border-radius:12px;box-shadow:0 14px 34px rgba(0,0,0,.18);
       padding:10px 14px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:15px}
  .msg-ok{color:#0f6b35}.msg-err{color:#a21919}.bar[hidden]{display:none}
</style>
</head>
<body>
<div class="wrap">
  <h1>Fichaje Puertas Lloris</h1>

  <div class="camWrap">
    <section class="card">
      <h3>Cámara</h3>
      <div class="cam">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="canvas"></canvas>
      </div>
      <div id="camStatus" class="hint">Inicializando cámara…</div>
    </section>
  </div>

  <div id="grid" class="grid"></div>
</div>

<div id="bar" class="bar" hidden><span id="barMsg" class="msg-ok">Listo</span></div>

<!-- GET por iframe para evitar CORS -->
<iframe id="hiddenFrame" name="hiddenFrame" style="display:none"></iframe>

<!-- Beep fallback -->
<audio id="beepAudio" preload="auto">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<script>
/*** CONFIG ***/
const ENDPOINT = "https://script.google.com/macros/s/AKfycbzQgMYWw08WXbJr5_SOhGKiHyqlU_Sh0ZU67dg2yS9DjDBMRMUbLemPBU9apPdKQa-c/exec";
const WORKERS  = [
  "Luis Bou Garcia",
  "Emilio Muñoz Usero",
  "Emilio Fernandez Muñoz",
  "Fernando Lloris Sanchez"
];
const TARGET_WIDTH = 480;   // más ligero
const JPEG_QUALITY = 0.5;

/*** DOM ***/
const grid = document.getElementById('grid');
const bar = document.getElementById('bar'), barMsg = document.getElementById('barMsg');
const video = document.getElementById('video'), canvas = document.getElementById('canvas'), camStatus = document.getElementById('camStatus');
const hiddenFrame = document.getElementById('hiddenFrame');
const beepTag = document.getElementById('beepAudio');

/*** Audio ***/
let audioUnlocked=false;
function unlockAudioOnce(){
  if(audioUnlocked) return;
  try{
    const AC=window.AudioContext||window.webkitAudioContext; const a=new AC(), o=a.createOscillator(), g=a.createGain();
    o.connect(g); g.connect(a.destination); g.gain.value=0; o.start(); o.stop(0); a.close(); audioUnlocked=true;
  }catch(_){ audioUnlocked=true; }
}
function beepOk(){
  try{
    const AC=window.AudioContext||window.webkitAudioContext; const a=new AC(), o=a.createOscillator(), g=a.createGain();
    o.connect(g); g.connect(a.destination); o.type='sine'; o.frequency.value=880; g.gain.setValueAtTime(0.06,a.currentTime);
    o.start(); setTimeout(()=>{o.stop(); a.close();},120);
  }catch(_){
    try{ beepTag.currentTime=0; beepTag.play().catch(()=>{});}catch(__){}
  }
}

/*** Cámara ***/
let camReady=false;
(async function initCam(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'},audio:false});
    video.srcObject=stream;
    video.addEventListener('loadeddata', ()=>{ camReady=true; camStatus.textContent='Cámara lista'; }, {once:true});
    await video.play().catch(()=>{});
  }catch(e){
    camReady=false; camStatus.textContent='Sin acceso a cámara (se enviará sin foto)';
  }
})();
function captureDataURL(){
  if(!camReady || !video.videoWidth) return '';
  const vw=video.videoWidth, vh=video.videoHeight, scale=TARGET_WIDTH/vw;
  const tw=Math.round(vw*scale), th=Math.round(vh*scale);
  canvas.width=tw; canvas.height=th;
  const ctx=canvas.getContext('2d');
  ctx.drawImage(video,0,0,tw,th); // captura NO espejada
  return canvas.toDataURL('image/jpeg', JPEG_QUALITY);
}

/*** Util ***/
function el(tag,attrs={},txt=''){ const n=document.createElement(tag);
  for(const k in attrs){ k==='class'? n.className=attrs[k] : n.setAttribute(k,attrs[k]); }
  if(txt) n.textContent=txt; return n;
}
function setBar(msg, ok=true){ barMsg.textContent=msg; barMsg.className=ok?'msg-ok':'msg-err'; bar.hidden=false; }
function beacon(url, payloadObj){
  try{
    const blob=new Blob([JSON.stringify(payloadObj)], {type:'text/plain;charset=UTF-8'});
    navigator.sendBeacon(url, blob);
  }catch(_){}
}

/*** Fichaje ***/
function ficha(nombre, tipo, btn){
  unlockAudioOnce();
  btn.setAttribute('aria-busy','true');

  // 1) Foto inmediata en paralelo
  const durl = captureDataURL();
  if (durl) beacon(ENDPOINT, { photo: durl, nombre, tipo });

  // 2) Alta por GET (iframe)
  const url = ENDPOINT + "?nombre=" + encodeURIComponent(nombre) + "&tipo=" + encodeURIComponent(tipo) + "&t=" + Date.now();
  const onDone = () => {
    btn.removeAttribute('aria-busy');
    beepOk();
    const stamp = new Date().toLocaleTimeString("es-ES",{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    setBar(`OK ${nombre} — ${tipo.toUpperCase()} ${stamp}`, true);

    // 3) Reenvío con pequeño retardo → asegura acople
    if (durl) setTimeout(()=>beacon(ENDPOINT, { photo: durl, nombre, tipo }), 350);

    hiddenFrame.removeEventListener('load', onDone);
  };
  hiddenFrame.addEventListener('load', onDone);
  hiddenFrame.src = url;
}

/*** Render (2×2 en tablet) ***/
WORKERS.forEach(nombre=>{
  const row = el('div',{class:'row'});
  const name = el('div',{class:'name'}, nombre);
  const btns = el('div',{class:'btns'});
  const bIn  = el('div',{class:'btn in',  role:'button', tabindex:'0'}, 'Entrada');
  const bOut = el('div',{class:'btn out', role:'button', tabindex:'0'}, 'Salida');
  btns.appendChild(bIn); btns.appendChild(bOut);
  row.appendChild(name); row.appendChild(btns);
  grid.appendChild(row);

  bIn.addEventListener('click', ()=>ficha(nombre,'entrada',bIn));
  bOut.addEventListener('click',()=>ficha(nombre,'salida', bOut));
  bIn.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ ficha(nombre,'entrada',bIn); e.preventDefault(); }});
  bOut.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' '){ ficha(nombre,'salida', bOut); e.preventDefault(); }});
});
</script>
</body>
</html>
