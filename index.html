<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Fichaje Puertas Lloris</title>
  <style>
    :root { --gap:16px; --btnH:54px; --green:#16a34a; --red:#dc2626; }
    body { margin:0; font-family:system-ui,Arial,sans-serif; background:#f4f6f8; color:#111; }
    .wrap { max-width:720px; margin:0 auto; padding:var(--gap); }
    h1 { text-align:center; font-size:22px; margin:10px 0 18px; }

    .card { background:#fff; border-radius:14px; box-shadow:0 4px 18px rgba(0,0,0,.12); padding:10px; margin-bottom:var(--gap); }
    .cam { width:100%; aspect-ratio:4/3; background:#000; border-radius:10px; overflow:hidden; }
    video { width:100%; height:100%; display:block; transform:scaleX(-1); } /* espejo */
    canvas { display:none; }
    #camStatus { font-size:12px; color:#666; margin-top:6px; text-align:center; }

    .grid { display:grid; grid-template-columns:1fr 1fr; gap:var(--gap); }
    .worker { background:#fff; border-radius:12px; padding:10px; box-shadow:0 2px 8px rgba(0,0,0,.08); text-align:center; }
    .name { font-weight:700; margin-bottom:10px; }
    .btns { display:flex; gap:10px; }
    button { flex:1; height:var(--btnH); border:0; border-radius:10px; font-size:15px; font-weight:700;
             color:#fff; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,.15); }
    button:active { transform:scale(.97); }
    .in { background:var(--green); }
    .out { background:var(--red); }

    .bar { margin-top:var(--gap); padding:12px; border-radius:12px; background:#fff;
           box-shadow:0 4px 12px rgba(0,0,0,.15); font-weight:700; text-align:center; }
    .ok { color:#0f6b35; } .err { color:#b91c1c; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Fichaje Puertas Lloris</h1>

    <div class="card">
      <div class="cam">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="canvas"></canvas>
      </div>
      <div id="camStatus">Cargando cámara…</div>
    </div>

    <div class="grid" id="workers"></div>
    <div id="status" class="bar">Listo</div>
  </div>

  <audio id="beep">
    <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
  </audio>

<script>
const WEBAPP="https://script.google.com/macros/s/AKfycbzQgMYWw08WXbJr5_SOhGKiHyqlU_Sh0ZU67dg2yS9DjDBMRMUbLemPBU9apPdKQa-c/exec";
const workers=["Luis Bou Garcia","Emilio Muñoz Usero","Emilio Fernandez Muñoz","Fernando Lloris Sanchez"];
const video=document.getElementById("video"), canvas=document.getElementById("canvas"), camStatus=document.getElementById("camStatus");
const beep=document.getElementById("beep"), statusBox=document.getElementById("status");
let camReady=false;

// Cámara
(async()=>{
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:false});
    video.srcObject=stream; await video.play().catch(()=>{});
    camReady=true; camStatus.textContent="Cámara lista";
  }catch(e){ camStatus.textContent="Sin acceso a cámara"; }
})();
function captureDataURL(){
  if(!camReady||!video.videoWidth) return "";
  canvas.width=video.videoWidth; canvas.height=video.videoHeight;
  canvas.getContext("2d").drawImage(video,0,0,canvas.width,canvas.height);
  return canvas.toDataURL("image/jpeg",0.6);
}

// Estado y beep
function setStatus(msg,ok=true){ statusBox.textContent=msg; statusBox.className="bar "+(ok?"ok":"err"); }
function playBeep(){ beep.currentTime=0; beep.play().catch(()=>{}); }

// JSONP
function jsonp(url,cb){ const id="cb_"+Math.random().toString(36).slice(2);
  window[id]=d=>{cb(d);delete window[id];s.remove();};
  const s=document.createElement("script"); s.src=url+(url.includes("?")?"&":"?")+"callback="+id;
  s.onerror=()=>{cb({ok:false,error:"jsonp"});delete window[id];s.remove();};
  document.head.appendChild(s);
}

// Fichar
function fichar(nombre,tipo){
  jsonp(`${WEBAPP}?nombre=${encodeURIComponent(nombre)}&tipo=${tipo}`, r=>{
    if(!r||!r.ok){ setStatus(`${nombre} — error`,false); return; }
    const stamp=new Date().toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
    setStatus(`OK ${nombre} — ${tipo} (${stamp})`,true);
    playBeep();

    const durl=captureDataURL();
    if(durl){ navigator.sendBeacon(WEBAPP, JSON.stringify({token:r.token||"", photo:durl, nombre, tipo})); }
  });
}

// Render botones
const container=document.getElementById("workers");
workers.forEach(n=>{
  const box=document.createElement("div"); box.className="worker";
  const name=document.createElement("div"); name.className="name"; name.textContent=n;
  const btns=document.createElement("div"); btns.className="btns";
  const bIn=document.createElement("button"); bIn.className="in"; bIn.textContent="Entrada"; bIn.onclick=()=>fichar(n,"entrada");
  const bOut=document.createElement("button"); bOut.className="out"; bOut.textContent="Salida"; bOut.onclick=()=>fichar(n,"salida");
  btns.appendChild(bIn); btns.appendChild(bOut);
  box.appendChild(name); box.appendChild(btns);
  container.appendChild(box);
});
</script>
</body>
</html>
