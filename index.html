<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Fichaje Puertas Lloris</title>
<style>
  :root{ --gap:10px; --btnH:40px; --fz:14px; --green:#16a34a; --red:#dc2626; }
  *{ box-sizing:border-box }
  body{ margin:0; font-family:system-ui,Arial,sans-serif; background:#eef2f6; color:#111; }
  .wrap{ max-width:860px; margin:0 auto; padding:12px; }
  h1{ text-align:center; font-size:18px; margin:6px 0 10px; }

  /* Cámara muy compacta */
  .camCard{ background:#fff; border-radius:10px; box-shadow:0 1px 8px rgba(0,0,0,.08); padding:6px; margin-bottom:10px;
            display:flex; justify-content:center; }
  .camBox{ width:100%; max-width:480px; aspect-ratio:4/3; background:#000; border-radius:8px; overflow:hidden; }
  video{ width:100%; height:100%; display:block; transform:scaleX(-1); }
  canvas{ display:none; }
  #camStatus{ text-align:center; font-size:11px; color:#666; margin-top:4px; }

  /* Tarjetas trabajador */
  .grid{ display:grid; gap:10px; grid-template-columns:repeat(4,1fr); }
  @media (max-width:980px){ .grid{ grid-template-columns:repeat(2,1fr);} }
  @media (max-width:520px){ .grid{ grid-template-columns:1fr;} }

  .worker{ background:#fff; border-radius:10px; box-shadow:0 1px 6px rgba(0,0,0,.08); padding:8px; }
  .name{ font-weight:700; text-align:center; font-size:13px; margin-bottom:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .btns{ display:grid; grid-template-columns:1fr 1fr; gap:6px; }
  button{ height:var(--btnH); border:0; border-radius:8px; font-size:var(--fz); font-weight:700; color:#fff; cursor:pointer; }
  button:active{ transform:scale(.98); }
  .in{ background:var(--green); } .out{ background:var(--red); }

  /* Barra estado compacta */
  .bar{ margin-top:10px; padding:8px; border-radius:10px; background:#fff; box-shadow:0 1px 8px rgba(0,0,0,.1);
        text-align:center; font-weight:700; font-size:13px; }
  .ok{ color:#0f6b35 } .err{ color:#b91c1c }
</style>
</head>
<body>
<div class="wrap">
  <h1>Fichaje Puertas Lloris</h1>

  <div class="camCard">
    <div style="display:flex; flex-direction:column; align-items:center;">
      <div class="camBox">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="canvas"></canvas>
      </div>
      <div id="camStatus">Cargando cámara…</div>
    </div>
  </div>

  <div id="workers" class="grid"></div>
  <div id="status" class="bar">Listo</div>
</div>

<audio id="beep">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>

<script>
const WEBAPP="https://script.google.com/macros/s/AKfycbzQgMYWw08WXbJr5_SOhGKiHyqlU_Sh0ZU67dg2yS9DjDBMRMUbLemPBU9apPdKQa-c/exec";
const PEOPLE=["Luis Bou Garcia","Emilio Muñoz Usero","Emilio Fernandez Muñoz","Fernando Lloris Sanchez"];
const video=document.getElementById("video"), canvas=document.getElementById("canvas"), camStatus=document.getElementById("camStatus");
const beep=document.getElementById("beep"), statusBox=document.getElementById("status");
let camReady=false;

/* Cámara */
(async()=>{
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:false});
    video.srcObject=stream; await video.play().catch(()=>{});
    camReady=true; camStatus.textContent="Cámara lista";
  }catch(_){ camStatus.textContent="Sin acceso a cámara"; }
})();
function captureDataURL(){
  if(!camReady||!video.videoWidth) return "";
  canvas.width=video.videoWidth; canvas.height=video.videoHeight;
  canvas.getContext("2d").drawImage(video,0,0,canvas.width,canvas.height);
  return canvas.toDataURL("image/jpeg",0.6);
}

/* Estado + beep */
function setStatus(msg,ok=true){ statusBox.textContent=msg; statusBox.className="bar "+(ok?"ok":"err"); }
function playBeep(){ try{beep.currentTime=0; beep.play();}catch(_){} }

/* JSONP util */
function jsonp(url,cb){
  const id="cb_"+Math.random().toString(36).slice(2);
  window[id]=d=>{ cb(d); delete window[id]; s.remove(); };
  const s=document.createElement("script");
  s.src=url+(url.includes("?")?"&":"?")+"callback="+id;
  s.onerror=()=>{ cb({ok:false}); delete window[id]; s.remove(); };
  document.head.appendChild(s);
}

/* Fichar */
function fichar(nombre,tipo){
  jsonp(`${WEBAPP}?nombre=${encodeURIComponent(nombre)}&tipo=${tipo}`, r=>{
    if(!r||!r.ok){ setStatus(`${nombre} — error`,false); return; }
    const t=new Date().toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit",second:"2-digit"});
    setStatus(`OK ${nombre} — ${tipo} (${t})`,true); playBeep();
    const d=captureDataURL(); if(d){ navigator.sendBeacon(WEBAPP, JSON.stringify({token:r.token||"", photo:d, nombre, tipo})); }
  });
}

/* Render compacto */
const grid=document.getElementById("workers");
PEOPLE.forEach(n=>{
  const card=document.createElement("div"); card.className="worker";
  card.innerHTML=`
    <div class="name">${n}</div>
    <div class="btns">
      <button class="in">Entrada</button>
      <button class="out">Salida</button>
    </div>`;
  card.querySelector(".in").onclick = ()=>fichar(n,"entrada");
  card.querySelector(".out").onclick= ()=>fichar(n,"salida");
  grid.appendChild(card);
});
</script>
</body>
</html>
